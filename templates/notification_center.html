<div class="ui segment basic container">
    <div class="ui breadcrumb">
        <a class="section">{{CONST.APP_NAME}}</a>
        <i class="right angle icon divider"></i>
        <div class="active section">Notification Center</div>
    </div>
    <div class="ui label blue pull-right">
        <i class="server icon"></i> Notification Service Connection Status: <span class="text" ng-class="{1:'green',3:'red'}[Notifications.status()]">{{CONST.WS_STATUS[Notifications.status()]}}
        </span>
        <!--<a class="" ng-click="Notifications.reconnect()" alt="reconnect to notification server"><i class="refresh icon"></i></a>-->
    </div>
    <div id="tabstrip" class="non-scrollable non-border">
        <ul>
            <li class="k-state-active">Notification</li>
            <li>Subscription</li>
        </ul>
        <div data-tab="Notification">
            <div class="ui segment blue form">
                <h5 class="ui header blue">
                    Search
                    <i class="link search icon pull-right" ng-click="listNotification()"></i>
                </h5>
                <div class="fields">
                    <div class="three wide field">
                        <label>Data Source</label>
                        <!--<div class="ui fluid selection dropdown">
                            <input name="datasource" type="hidden" ng-model="search.datasource" value="{{search.datasource}}">
                            <i class="dropdown icon"></i>
                            <div class="default text">Data Source</div>
                            <div class="menu">
                                <div class="item" data-value="0">All</div>
                                <div class="item" ng-repeat="(v,p) in platforms" data-value="{{v}}">{{p}}</div>
                            </div>-->
                        <select class="ui fluid dropdown" ng-model="search.datasource">
                            <option value="all">All</option>
                            <option value="{{v}}" ng-repeat="(v,p) in CONST.ALL_ENABLED_PLARFORMS">{{p}}</option>
                            </select>
                        <!--</div>-->
                    </div>
                    <div class="three wide field">
                        <label>Service/Product</label>
                        <select class="ui fluid dropdown service" ng-model="search.topic">
                            <option value="all">All</option>
                            <option value="{{topic.TechCategoryName}}" ng-repeat="topic in topics | filter:{isGA:true}">{{topic.TechCategoryName}}</option>
                        </select>
                    </div>
                    <div class="five wide field">
                        <label>Message Type</label>
                        <!--<div class="ui fluid selection dropdown">
                            <input name="messagetype" type="hidden" ng-model="search.messagetype" value="{{search.messagetype}}">
                            <i class="dropdown icon"></i>
                            <div class="default text">Message Type</div>
                            <div class="menu">
                                <div class="item" data-value="0">All</div>
                                <div class="item" ng-repeat="(k,v) in CONST.MESSAGE_TYPES" data-value="{{k}}">{{v}}</div>
                            </div>-->
                        <!--<option value="0">all</option>-->
                        <!--<option value="{{v}}" ng-repeat="(v,p) in platforms" ng-init="$last && finished()">{{p}}</option>-->
                        <!--</div>-->
                        <select class="ui fluid dropdown" ng-model="search.messagetype">
                            <option value="all">All</option>
                            <option value="{{k}}" ng-repeat="(k,v) in CONST.MESSAGE_TYPES">{{v}}</option>
                        </select>
                    </div>
                    <div class="three wide field">
                        <label>Data Download Available</label>
                        <!--<div class="ui fluid selection dropdown">
                            <input name="downloadable" type="hidden" ng-model="search.downloadable" value="{{search.downloadable}}">
                            <i class="dropdown icon"></i>
                            <div class="default text">Data Download Available</div>
                            <div class="menu">
                                <div class="item" data-value="0">All</div>
                                <div class="item" data-value="1">Available</div>
                                <div class="item" data-value="-1">Unavailable</div>
                            </div>-->
                        <!--<option value="0">all</option>-->
                        <!--<option value="{{v}}" ng-repeat="(v,p) in platforms" ng-init="$last && finished()">{{p}}</option>-->
                        <!--</div>-->
                        <select class="ui fluid dropdown" ng-model="search.downloadable">
                            <option value="all">All</option>
                            <option value="1">Available</option>
                            <option value="-1">Unavailable</option>
                        </select>
                    </div>
                </div>
                <div class="fields">
                    <div class="three wide field">
                        <label>Start Date</label>
                        <datepicker date-format="yyyy-MM-dd" id="bgTime" date-max-limit="{{search.egTime}}" selector="input-text">
                            <div class="ui left icon input">
                                <input class="input-text" ng-model="search.bgTime" type="text" />
                                <i class="calendar icon"></i>
                            </div>
                        </datepicker>
                    </div>
                    <div class="three wide field">
                        <label>End Date</label>
                        <datepicker date-format="yyyy-MM-dd" id="egTime" date-min-limit="{{search.bgTime}}" selector="input-text">
                            <div class="ui left icon input">
                                <input class="input-text" ng-model="search.egTime" type="text" />
                                <i class="calendar icon"></i>
                            </div>
                        </datepicker>
                    </div>
                </div>
            </div>
            <div class="ui basic segment" id="nc-main" style="padding-left:0px;padding-right:0px;">
                <div class="ui dimmer">
                    <div class="ui text loader">Loading</div>
                </div>
                <table st-table="stTable" st-safe-src="collections" class="ui striped green table">
                    <thead>
                        <tr>
                            <th st-sort="createdTime" st-sort-default="reverse" st-skip-natural="true" style="color: blue !important;cursor: pointer !important;">Date
                                <span class="label">
                                <i class="popup small link info circle icon" data-content="Notification Created Time" data-variation="mini inverted"></i>
                            </span>
                            </th>
                            <th>Data Source
                                <span class="label">
                                <i class="popup small link info circle icon" data-content="Platform" data-variation="mini inverted"></i>
                            </span>
                            </th>
                            <th>Service/Product
                                <span class="label">
                                <i class="popup small link info circle icon" data-content="Service or Product" data-variation="mini inverted"></i>
                            </span>
                            </th>
                            <th>Message Type
                                <span class="label">
                                <i class="popup small link info circle icon" data-content="Notification Detected Issue Types" data-variation="mini inverted"></i>
                            </span>
                            </th>
                            <th>Data Download
                                <span class="label">
                                <i class="popup small link info circle icon" data-content="Is Supported for Downloading Raw Data" data-variation="mini inverted"></i>
                            </span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="m in stTable">
                            <td>{{m.createdTime|mankindTime2String}}</td>
                            <td>{{CONST.ALL_ENABLED_PLARFORMS[m.forumName]}}</td>
                            <td>{{m.topic}}</td>
                            <td>
                                <div ng-if="m.hasDetails">
                                    <a style="cursor:pointer" ng-click="showdetails(m)">{{CONST.MESSAGE_TYPES[m.msgType]}}</a>
                                </div>
                                <div ng-if="!m.hasDetails">
                                    {{CONST.MESSAGE_TYPES[m.msgType]}}
                                </div>
                            </td>
                            <td>
                                <div ng-bind-html="generateDownloadUrl(m)"></div>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="5">
                                <div st-items-by-page="10" st-pagination="" st-template="/public/template/pagination.custom.html"></div>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <div data-tab="Subscription">
            <div class="ui segment blue form" data-bind="visible: isAdmin">
                <h5 class="ui header blue">
                    Search
                    <i class="link search icon pull-right" ng-click="listNotification()"></i>
                </h5>
                <div class="fields">
                </div>
            </div>
            <button class="ui icon green button" data-bind="visible: isAdmin, events: { click: onCreateSubscription }">
                <i class="plus icon"></i>Create Subscription
            </button>
            <div class="ui striped green table stTable">
                <div data-role="grid" data-scrollable="false" data-columns="[{
                        field: 'email',
                        groupHeaderTemplate: kendo.template($('#templateSubscriptionManagement').html()),
                        hidden: true
                     },{
                        title: 'Platform',
                        field: 'platforms',
                        template: '#=platforms#',
                        width: '200px'
                     }, {
                        title: 'Topic',
                        field: 'topics',
                        template: '#=topics#'
                     }, {
                        title: 'Message Type',
                        field: 'types',
                        template: '#=types#',
                        width: '300px'
                     }]" data-bind="
                        source: subscriptions,
                        events: {
                            dataBound: onSubscriptionBound
                        }"></div>
            </div>
            <div id="dialogSubscriptionEditor" class="form" style="display: none;">
                <div class="field">
                    <div class="caption">Email</div>
                    <input type="text" class="k-textbox" style="width: 300px;" data-bind="value: editSubscription.email, enabled: editSubscription.isEmailEditable, style: { border: editSubscription.emailFieldBorderStyle }" />
                </div>
                <div class="field">
                    <div class="caption">Platform</div>
                    <div class="value">
                        <input data-role="dropdownlist" data-text-field="text" data-value-field="value" data-bind="value: editSubscription.platform, source: flatforms"
                            style="width: 300px;" />
                    </div>
                </div>
                <div class="field">
                    <div class="caption">Topic</div>
                    <div class="value" style="width: 300px;">
                        <select data-role="multiselect" data-placeholder="Select Topics ..." data-bind="value: editSubscription.topics, source: editSubscription.topicsInForum"></select>
                    </div>
                </div>
                <div class="field">
                    <div class="caption">Message Type</div>
                    <div class="value">
                        <input data-role="dropdownlist" data-text-field="text" data-value-field="value" data-bind="value: editSubscription.messagetype, source: messagetypes"
                            style="width: 300px;" />
                    </div>
                </div>
                <div class="actions">
                    <div class="ui cancel button" data-bind="events: { click: onSubscriptionEditorClose }">Cancel</div>
                    <div class="ui approve button" data-bind="events: { click: onSubscriptionUpdate }">OK</div>
                </div>
            </div>
            <script id="templateSubscriptionManagement" type="text/x-kendo-template">
                #=value#
                <i class="icon remove subscription" title="remove subscription"></i>
                <i class="icon write subscription" title="edit subscription"></i>
            </script>
            <script type="text/javascript">
                var datastore = [{
                    email: 'v1@com',
                    subscriptions: [{
                        platforms: ["so"],
                        topics: ["Azure", "UWP", "powerbi", "powerapp", "MS Flow", "EMS", "VS&VSTS"],
                        types: ["InfluenceVolumeSpikeDetected"]
                    }, {
                        platforms: ["tn"],
                        topics: ["powerapp"],
                        types: ["ServiceOutageDetected"]
                    }]
                }, {
                    email: 'v2@com',
                    subscriptions: [{
                        platforms: ["twitter"],
                        topics: ["UWP"],
                        types: ["UniqueUserSessionsSpikeDetected"]
                    }, {
                        platforms: ["msdn"],
                        topics: ["powerbi"],
                        types: ["SupportExperienceIssuesDetected"]
                    }]
                }];
                var editSubscription = kendo.data.Model.define({
                    fields: {
                        email: { type: "string" },
                        platform: { type: "string" },
                        topics: { type: "object" },
                        messagetype: { type: "string" },
                        topicSource: { type: "object" }
                    },
                    isEmailEditable: function () {
                        var email = this.get("email");
                        return (this.get("email") || "").length === 0;
                    },
                    emailFieldBorderStyle: function () {
                        if (this.get("isEmailEditable()") === false) {
                            return "none";
                        }
                        return "";
                    },
                    topicsInForum: function () {
                        var topicSource = this.get("topicSource") || {};
                        var platform = this.get("platform") || "all";
                        return topicSource[platform] || [];
                    }
                });
                $("#tabstrip").kendoTabStrip({
                    scrollable: false
                });

                var scope = angular.element("html").scope();
                var flatforms = [{ value: "all", text: "All", }];
                var topics = { all: [] };
                var messagetypes = [{ value: "all", text: "All", }];
                $.each(scope.CONST.ALL_ENABLED_PLARFORMS, function (key, value) {
                    flatforms.push({ value: key, text: value });
                });
                $.each(scope.CONST.MESSAGE_TYPES, function (key, value) {
                    messagetypes.push({ value: key, text: value });
                });
                scope.service.getCate().then(function (categories) {
                    $.each(categories, function (i, category) {
                        if (category.isGA === true) {
                            var name = category.TechCategoryName;
                            $.each(category.Platforms, function (j, platform) {
                                if (platform.isEnabled === true) {
                                    if (topics.all.indexOf(name) < 0) {
                                        topics.all.push(name);
                                    }
                                    if (platform.PlatformName in topics) {
                                        var array = topics[platform.PlatformName];
                                        if (array.indexOf(name) < 0) {
                                            array.push(name);
                                        }
                                    } else {
                                        topics[platform.PlatformName] = [name];
                                    }
                                }
                            });
                        }
                    });
                    viewModel.set("topics", topics);
                });

                var viewModel = kendo.observable({
                    isAdmin: true,
                    subscriptions: new kendo.data.DataSource({
                        transport: {
                            read: function (options) {
                                var platdata = [];
                                $.each(datastore, function (i, data) {
                                    if ((data.subscriptions)
                                        && ((viewModel.isAdmin === true)
                                            || ((scope.userInfo) && (scope.userInfo.userName === data.email)))) {
                                        $.each(data.subscriptions, function (j, subscription) {
                                            var platformNames = []
                                            if (subscription.platforms) {
                                                $.each(subscription.platforms, function (k, platform) {
                                                    platformNames.push(scope.CONST.ALL_ENABLED_PLARFORMS[platform]);
                                                });
                                            }
                                            platdata.push({
                                                email: data.email,
                                                platforms: platformNames.join('<br />'),
                                                topics: subscription.topics
                                                    ? subscription.topics.join(', ')
                                                    : '',
                                                types: subscription.types
                                                    ? subscription.types.join('<br />')
                                                    : ''
                                            });
                                        });
                                    }
                                });
                                if ((platdata.length === 0)
                                    && (viewModel.isAdmin === false)) {
                                    platdata.push({
                                        email: scope.userInfo.userName,
                                        platforms: '',
                                        topics: '',
                                        types: ''
                                    });
                                }
                                options.success(platdata);
                            }
                        },
                        group: { field: 'email' }
                    }),
                    editSubscription: new editSubscription(),
                    onSubscriptionBound: function (e) {
                        var grid = e.sender;
                        $.each(grid.tbody.children("tr.k-grouping-row"), function (i, row) {
                            var data = grid.dataItem(row);
                            row = $(row);
                            row.find("i.write.subscription").click(function (e) {
                                viewModel.set("editSubscription.email", data.email);
                                viewModel.set("editSubscription.platform", "all");
                                viewModel.set("editSubscription.topics", []);
                                viewModel.set("editSubscription.messagetype", "all");
                                subscriptionEditor.center().open();
                            });
                            row.find("i.remove.subscription").click(function (e) {
                                alert('remove ' + data.email);
                            });
                        });
                    },
                    onCreateSubscription: function (e) {
                        viewModel.set("editSubscription.email", null);
                        viewModel.set("editSubscription.platform", "all");
                        viewModel.set("editSubscription.topics", []);
                        viewModel.set("editSubscription.messagetype", "all");
                        subscriptionEditor.center().open();
                    },
                    onSubscriptionEditorClose: function (e) {
                        subscriptionEditor.close();
                    },
                    onSubscriptionUpdate: function (e) {
                        subscriptionEditor.close();
                    },
                    messagetypes: messagetypes,
                    topics: topics,
                    flatforms: flatforms
                });
                viewModel.bind("change", function (e) {
                    if (e.field === "topics") {
                        this.set("editSubscription.topicSource", topics);
                    }
                });
                //kendo.bind($('#tabstrip-2'), viewModel);
                kendo.bind($('html'), viewModel);

                var subscriptionEditor = $("#dialogSubscriptionEditor").kendoWindow({
                    animation: false,
                    modal: true,
                    scrollable: false,
                    resizable: false,
                    title: "Edit Subscription",
                    width: 464,
                    visible: false
                }).data("kendoWindow");
                $("#dialogSubscriptionEditor")
                    .parent()
                    .find("span.k-window-title")
                    .css({
                        fontSize: "18px",
                        fontWeight: "500"
                    });
            </script>
        </div>
    </div>
</div>